#!/bin/bash
# MCP 服务管理脚本
# 用法: ./mcp <command> [service...]

set -e

# 颜色定义 (使用 tput 以获得更好的兼容性，如果 tput 不可用则回退到 ANSI 码)
if command -v tput >/dev/null 2>&1; then
    RED=$(tput setaf 1)
    GREEN=$(tput setaf 2)
    YELLOW=$(tput setaf 3)
    BLUE=$(tput setaf 4)
    BOLD=$(tput bold)
    NC=$(tput sgr0)
else
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    BOLD='\033[1m'
    NC='\033[0m'
fi

# 项目根目录
PROJECT_ROOT="$(cd "$(dirname "$0")" && pwd)"
cd "$PROJECT_ROOT"

# 网络名称
NETWORK_NAME="mcp-network"

# 服务定义格式: "服务名:Compose文件路径:描述"
SERVICES=(
    "filesystem:services/filesystem/docker-compose.yaml:文件系统访问"
    "obsidian:services/obsidian/docker-compose.yaml:Obsidian 笔记"
    "postgres:services/postgres/docker-compose.yaml:PostgreSQL 数据库"
)

# 输出函数
info() { printf "${BLUE}ℹ %s${NC}\n" "$1"; }
success() { printf "${GREEN}✓ %s${NC}\n" "$1"; }
error() { printf "${RED}✗ %s${NC}\n" "$1"; }
warn() { printf "${YELLOW}⚠ %s${NC}\n" "$1"; }

# 显示帮助信息
show_help() {
    cat << EOF
${GREEN}${BOLD}MCP 服务管理工具${NC}

${BOLD}用法:${NC}
    ./mcp <命令> [参数...]

${BOLD}命令:${NC}
    ${GREEN}build${NC} [image]     构建镜像
    ${GREEN}start${NC} [service]   启动服务（不指定则启动所有）
    ${GREEN}stop${NC} [service]    停止服务（不指定则停止所有）
    ${GREEN}restart${NC} [service] 重启服务
    ${GREEN}status${NC}            查看状态
    ${GREEN}logs${NC} [service]    查看日志
    ${GREEN}list${NC}              列出服务
    ${GREEN}network${NC}           管理网络
    ${GREEN}clean${NC}             清理资源

${BOLD}可用服务:${NC}
EOF
    for service in "${SERVICES[@]}"; do
        IFS=':' read -r name file desc <<< "$service"
        printf "    ${BLUE}%-15s${NC} %s\n" "$name" "$desc"
    done
}

# 确保网络存在
ensure_network() {
    if ! docker network inspect "$NETWORK_NAME" &> /dev/null; then
        info "创建网络: $NETWORK_NAME"
        docker network create "$NETWORK_NAME" >/dev/null
        success "网络创建成功"
    fi
}

# 获取服务配置
get_service_config() {
    local service_name=$1
    for service in "${SERVICES[@]}"; do
        IFS=':' read -r name file desc <<< "$service"
        if [ "$name" = "$service_name" ]; then
            echo "$file"
            return 0
        fi
    done
    return 1
}

# 获取所有 compose 文件
get_all_compose_files() {
    local files=()
    for service in "${SERVICES[@]}"; do
        IFS=':' read -r name file desc <<< "$service"
        if [ -f "$file" ]; then
            files+=("-f" "$file")
        fi
    done
    echo "${files[@]}"
}

# 构建镜像
build_images() {
    local target=$1
    
    # 检查是否提供了镜像名称
    if [ -z "$target" ]; then
        error "请指定要构建的镜像名称"
        echo -e "${YELLOW}可用镜像:${NC}"
        find images -name "build.sh" -exec dirname {} \; | xargs -n1 basename | sed 's/^/  - /'
        return 1
    fi

    info "开始构建镜像..."
    
    # 查找 images 目录下所有的 build.sh
    local build_scripts=$(find images -name "build.sh")
    
    if [ -z "$build_scripts" ]; then
        error "未找到构建脚本 (images/*/build.sh)"
        return 1
    fi

    local found=false
    for script in $build_scripts; do
        # 获取镜像目录名作为镜像标识
        local dir_name=$(basename $(dirname "$script"))
        
        if [ "$target" = "$dir_name" ]; then
            info "执行构建脚本: $script"
            if bash "$script"; then
                success "$dir_name 镜像构建成功"
            else
                error "$dir_name 镜像构建失败"
                return 1
            fi
            found=true
            break  # 找到并构建后退出循环
        fi
    done

    if [ "$found" = "false" ]; then
        error "未找到镜像: $target"
        return 1
    fi
}

# 启动服务
start_services() {
    ensure_network
    
    if [ $# -eq 0 ]; then
        info "启动所有服务..."
        local compose_files=$(get_all_compose_files)
        if [ -z "$compose_files" ]; then
            error "没有找到服务配置文件"
            return 1
        fi
        # shellcheck disable=SC2086
        docker-compose $compose_files up -d
        success "所有服务已启动"
    else
        for service_name in "$@"; do
            local compose_file=$(get_service_config "$service_name")
            if [ -n "$compose_file" ]; then
                info "启动服务: $service_name"
                docker-compose -f "$compose_file" up -d
                success "$service_name 已启动"
            else
                error "未知服务: $service_name"
            fi
        done
    fi
}

# 停止服务
stop_services() {
    if [ $# -eq 0 ]; then
        info "停止所有服务..."
        local compose_files=$(get_all_compose_files)
        if [ -n "$compose_files" ]; then
            # shellcheck disable=SC2086
            docker-compose $compose_files down
            success "所有服务已停止"
        fi
    else
        for service_name in "$@"; do
            local compose_file=$(get_service_config "$service_name")
            if [ -n "$compose_file" ]; then
                info "停止服务: $service_name"
                docker-compose -f "$compose_file" down
                success "$service_name 已停止"
            else
                error "未知服务: $service_name"
            fi
        done
    fi
}

# 查看状态
show_status() {
    info "MCP 服务状态:"
    echo ""
    docker ps --filter "label=mcp.service" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

# 查看日志
show_logs() {
    if [ $# -eq 0 ]; then
        local compose_files=$(get_all_compose_files)
        # shellcheck disable=SC2086
        docker-compose $compose_files logs -f
    else
        local service_name=$1
        local compose_file=$(get_service_config "$service_name")
        if [ -n "$compose_file" ]; then
            docker-compose -f "$compose_file" logs -f
        else
            error "未知服务: $service_name"
        fi
    fi
}

# 列出列表
list_info() {
    echo -e "${GREEN}${BOLD}可用服务:${NC}"
    for service in "${SERVICES[@]}"; do
        IFS=':' read -r name file desc <<< "$service"
        if docker ps --filter "label=mcp.service=$name" --format "{{.Names}}" | grep -q .; then
            status="${GREEN}● 运行中${NC}"
        else
            status="${RED}○ 已停止${NC}"
        fi
        printf "  %-15s %s  %s\n" "$name" "$status" "$desc"
    done
}

# 主逻辑
main() {
    local command=${1:-help}
    shift || true

    case "$command" in
        build)
            build_images "$@"
            ;;
        start)
            start_services "$@"
            ;;
        stop)
            stop_services "$@"
            ;;
        restart)
            stop_services "$@"
            start_services "$@"
            ;;
        status)
            show_status
            ;;
        logs)
            show_logs "$@"
            ;;
        list)
            list_info
            ;;
        network)
            ensure_network
            ;;
        clean)
            docker container prune -f
            docker image prune -f
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            error "未知命令: $command"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
